{% extends "base.html" %}

{% block title %}Lista de Presentes - {{ config.nome_noiva or 'Iara' }} & {{ config.nome_noivo or 'Samuel' }}{% endblock %}

{% block extra_head %}
<style>
    /* Hero Gifts Styles */
    .hero-gifts {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        min-height: 60vh;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .hero-gifts .hero-overlay {
        background: rgba(0, 0, 0, 0.1);
    }
    
    .hero-gifts .page-title {
        color: var(--white);
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .hero-gifts .page-subtitle {
        color: var(--white);
        font-size: 1.3rem;
        max-width: 800px;
        margin: 0 auto;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        line-height: 1.6;
    }
    
    /* Gifts Section Styles */
    .gift-categories {
        padding: 4rem 0;
        background: var(--white);
    }
    
    @media (max-width: 768px) {
        .hero-gifts {
            min-height: 50vh;
        }
        
        .hero-gifts .page-title {
            font-size: 2.5rem;
        }
        
        .hero-gifts .page-subtitle {
            font-size: 1.1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section - Presentes -->
<section class="hero hero-gifts" id="hero-gifts">
    <div class="hero-background">
        <div class="hero-overlay"></div>
    </div>
    
    <div class="hero-content">
        <div class="container">
            <h1 class="page-title heading-script">
                Lista de Presentes
            </h1>
            
            <p class="page-subtitle text-large text-center">
                Escolha um presente especial para nós! Sua presença já é o maior presente, 
                mas se quiser nos presentear, aqui estão algumas sugestões ♥
            </p>
        </div>
    </div>
</section>

<!-- Gift Categories -->
<section class="gift-categories section">
    <div class="container">
        <!-- Search Box -->
        <div class="gift-search">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="gift-search-input" placeholder="Buscar presentes...">
                <button type="button" id="clear-search" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="categories-filter">
            <button class="category-btn active" data-category="todos">
                <i class="fas fa-th"></i>
                Todos
            </button>
            <button class="category-btn" data-category="casa">
                <i class="fas fa-home"></i>
                Casa
            </button>
            <button class="category-btn" data-category="cozinha">
                <i class="fas fa-utensils"></i>
                Cozinha
            </button>
            <button class="category-btn" data-category="quarto">
                <i class="fas fa-bed"></i>
                Quarto
            </button>
            <button class="category-btn" data-category="sala">
                <i class="fas fa-couch"></i>
                Sala
            </button>
            <button class="category-btn" data-category="experiencias">
                <i class="fas fa-plane"></i>
                Experiências
            </button>
        </div>
    </div>
</section>

<!-- Gifts Grid -->
<section class="gifts-section">
    <div class="container">
        {% if presentes %}
            <div class="gifts-grid" id="gifts-grid">
                {% for presente in presentes %}
                <div class="gift-card" data-category="{{ presente.categoria }}" data-id="{{ presente.id }}">
                    <div class="gift-image">
                        {% if presente.imagem_url %}
                            <div class="loading-spinner"></div>
                            <img src="{{ presente.imagem_url }}" alt="{{ presente.nome }}" 
                                 onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';"
                                 onerror="this.style.display='none'; this.previousElementSibling.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <div class="gift-placeholder" {% if presente.imagem_url %}style="display: none;"{% endif %}>
                            <i class="fas fa-gift"></i>
                        </div>
                        
                        {% if not presente.disponivel %}
                            <div class="gift-chosen-badge">
                                <i class="fas fa-check"></i>
                                <span>Escolhido</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="gift-content">
                        <h3 class="gift-name font-semibold">{{ presente.nome }}</h3>
                        
                        {% if presente.descricao %}
                            <p class="gift-description text-small">
                                {% if " - Loja: " in presente.descricao %}
                                    {{ presente.descricao.split(" - Loja: ")[0] }}
                                {% else %}
                                    {{ presente.descricao }}
                                {% endif %}
                            </p>
                        {% endif %}
                        
                        <div class="gift-details">
                            {% if presente.preco_sugerido %}
                                <div class="gift-price">
                                    <i class="fas fa-tag"></i>
                                    <span class="font-medium">R$ {{ "%.2f"|format(presente.preco_sugerido) }}</span>
                                </div>
                            {% endif %}
                            
                            {% if presente.descricao and " - Loja: " in presente.descricao %}
                                <div class="gift-store">
                                    <i class="fas fa-store"></i>
                                    <span class="text-small">{{ presente.descricao.split(" - Loja: ")[-1] }}</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="gift-actions">
                            {% if presente.disponivel %}
                                <button class="btn btn-primary btn-block" onclick="chooseGift({{ presente.id }})">
                                    <i class="fas fa-heart"></i>
                                    Escolher Este Presente
                                </button>
                            {% else %}
                                <button class="btn btn-disabled btn-block" disabled>
                                    <i class="fas fa-check"></i>
                                    Já foi escolhido
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Empty State for Filtered Results -->
            <div class="empty-state text-center" id="empty-state" style="display: none;">
                <div class="empty-icon text-primary">
                    <i class="fas fa-search"></i>
                </div>
                <h3 class="font-semibold">Nenhum presente encontrado</h3>
                <p class="text-secondary">Não encontramos presentes nesta categoria. Tente outra categoria.</p>
            </div>
        {% else %}
            <!-- No Gifts State -->
            <div class="empty-state text-center">
                <div class="empty-icon text-primary">
                    <i class="fas fa-gift"></i>
                </div>
                <h3 class="font-semibold">Lista de presentes em breve</h3>
                <p class="text-secondary">Estamos preparando nossa lista de presentes com muito carinho. Volte em breve!</p>
                <a href="{{ url_for('main.index') }}" class="btn btn-primary">
                    <i class="fas fa-home"></i>
                    Voltar ao Início
                </a>
            </div>
        {% endif %}
    </div>
</section>

<!-- Navegação Step by Step -->
<section class="step-navigation-section">
    <div class="container">
        <div class="step-navigation-bottom">
            <a href="{{ url_for('main.local') }}" class="btn btn-step-prev">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar ao Local</span>
            </a>
            <div class="step-completion">
                <i class="fas fa-check-circle"></i>
                <span>Parabéns! Você completou todo o convite!</span>
            </div>
            <a href="{{ url_for('main.index') }}" class="btn btn-step-restart">
                <i class="fas fa-home"></i>
                <span>Voltar ao Início</span>
            </a>
        </div>
    </div>
</section>

<!-- Gift Selection Modal -->
<div class="modal-overlay" id="gift-modal" onclick="closeGiftModal()">
    <div class="modal-container" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Escolher Presente</h3>
            <button class="modal-close" onclick="closeGiftModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="gift-selection-info">
                <div class="selected-gift-preview">
                    <div class="gift-preview-image">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="gift-preview-details">
                        <h4 id="selected-gift-name">Nome do Presente</h4>
                        <p id="selected-gift-price">R$ 0,00</p>
                    </div>
                </div>
                
                <p class="selection-message">
                    <i class="fas fa-heart"></i>
                    Que lindo! Você escolheu este presente para nós. Por favor, preencha seus dados para confirmarmos.
                </p>
            </div>
            
            <form id="gift-selection-form" class="gift-form">
                <input type="hidden" id="presente-id" name="presente_id">

                <div class="form-group">
                    <label for="nome-presenteador">Seu Nome Completo *</label>
                    <input type="text" id="nome-presenteador" name="nome_presenteador" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="email-presenteador">Seu E-mail *</label>
                    <input type="email" id="email-presenteador" name="email_presenteador" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="telefone-presenteador">Seu Telefone</label>
                    <input type="tel" id="telefone-presenteador" name="telefone_presenteador" class="form-control" placeholder="(11) 99999-9999">
                </div>

                <div class="form-group">
                    <label for="mensagem-presente">Mensagem (opcional)</label>
                    <textarea id="mensagem-presente" name="mensagem" rows="3" class="form-control" placeholder="Deixe uma mensagem carinhosa para os noivos..."></textarea>
                </div>

                <div class="form-actions modal-body-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGiftModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-confirm">
                        <i class="fas fa-heart"></i>
                        Confirmar Escolha
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Back to Home Section -->
<section class="back-section">
    <div class="container">
        <div class="back-content">
            <div class="back-message">
                <h3>Obrigado por pensar em nós! ♥</h3>
                <p>Sua presença já é o maior presente, mas ficamos muito felizes com seu carinho.</p>
            </div>
            
            <div class="back-actions">
                <a href="{{ url_for('main.index') }}" class="btn btn-outline">
                    <i class="fas fa-home"></i>
                    Voltar ao Início
                </a>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Filter gifts by category
document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const category = this.dataset.category;
        const gifts = document.querySelectorAll('.gift-card');
        const emptyState = document.getElementById('empty-state');
        let visibleCount = 0;
        
        gifts.forEach(gift => {
            if (category === 'todos' || gift.dataset.category === category) {
                gift.style.display = 'block';
                visibleCount++;
            } else {
                gift.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        if (visibleCount === 0) {
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
        }
    });
});

// Choose gift function
function chooseGift(giftId) {
    const giftCard = document.querySelector(`[data-id="${giftId}"]`);
    const giftName = giftCard.querySelector('.gift-name').textContent;
    const giftPriceElement = giftCard.querySelector('.gift-price span');
    const giftPrice = giftPriceElement ? giftPriceElement.textContent : 'Preço não informado';
    
    // Update modal content
    document.getElementById('selected-gift-name').textContent = giftName;
    document.getElementById('selected-gift-price').textContent = giftPrice;
    document.getElementById('presente-id').value = giftId;
    
    // Show modal
    const modal = document.getElementById('gift-modal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

// Close gift modal
function closeGiftModal() {
    const modal = document.getElementById('gift-modal');
    if (modal) modal.classList.remove('active');
    document.body.style.overflow = '';

    // Reset form if exists
    const form = document.getElementById('gift-selection-form');
    if (form) form.reset();
}

// Handle gift selection form
const giftForm = document.getElementById('gift-selection-form');
if (giftForm) {
    giftForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirmando...';
    submitBtn.disabled = true;
    
    fetch('{{ url_for("main.escolher_presente") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update gift card to show as chosen
            const giftCard = document.querySelector(`[data-id="${data.presente_id}"]`);
            if (giftCard) {
                giftCard.querySelector('.gift-actions').innerHTML = `
                    <button class="btn btn-disabled btn-block" disabled>
                        <i class="fas fa-check"></i>
                        Já foi escolhido
                    </button>
                `;
                
                // Add chosen badge
                const giftImage = giftCard.querySelector('.gift-image');
                giftImage.innerHTML += `
                    <div class="gift-chosen-badge">
                        <i class="fas fa-check"></i>
                        <span>Escolhido</span>
                    </div>
                `;
            }
            
            // Show success message with store link
            showSuccessWithStoreLink(data.nome_presente, data.link_loja);
            closeGiftModal();
        } else {
            showMessage('error', data.message || 'Erro ao escolher presente. Tente novamente.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('error', 'Erro ao escolher presente. Tente novamente.');
    })
    .finally(() => {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
}

// Show success message with store link
function showSuccessWithStoreLink(nomePresente, linkLoja) {
    const flashContainer = document.querySelector('.flash-messages') || createFlashContainer();
    
    const flashMessage = document.createElement('div');
    flashMessage.className = 'flash-message flash-success';
    
    let messageContent = `
        <div style="margin-bottom: 15px;">
            <strong>🎉 Presente escolhido com sucesso!</strong><br>
            Obrigado por escolher: <strong>${nomePresente}</strong> ♥
        </div>
    `;
    
    if (linkLoja) {
        messageContent += `
            <div style="text-align: center; margin: 15px 0;">
                <a href="${linkLoja}" target="_blank" class="btn btn-primary" style="display: inline-block; background: #e74c3c; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; margin: 5px;">
                    <i class="fas fa-shopping-bag"></i> Ir para a Loja
                </a>
            </div>
            <small style="color: #666;">
                <i class="fas fa-info-circle"></i> A página da loja será aberta automaticamente em 3 segundos
            </small>
        `;
        
        // Auto redirect after 3 seconds
        setTimeout(() => {
            window.open(linkLoja, '_blank');
        }, 3000);
    }
    
    flashMessage.innerHTML = `
        ${messageContent}
        <button type="button" class="flash-close" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
    `;
    
    flashContainer.appendChild(flashMessage);
    
    // Auto close after 10 seconds
    setTimeout(() => {
        if (flashMessage.parentNode) {
            flashMessage.remove();
        }
    }, 10000);
    
    // Close button
    flashMessage.querySelector('.flash-close').addEventListener('click', () => {
        flashMessage.remove();
    });
    
    // Scroll to top to show message
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Show message function
function showMessage(type, message) {
    const flashContainer = document.querySelector('.flash-messages') || createFlashContainer();
    
    const flashMessage = document.createElement('div');
    flashMessage.className = `flash-message flash-${type}`;
    flashMessage.innerHTML = `
        <span>${message}</span>
        <button type="button" class="flash-close">&times;</button>
    `;
    
    flashContainer.appendChild(flashMessage);
    
    // Auto close after 5 seconds
    setTimeout(() => {
        flashMessage.remove();
    }, 5000);
    
    // Close button
    flashMessage.querySelector('.flash-close').addEventListener('click', () => {
        flashMessage.remove();
    });
    
    // Scroll to top to show message
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function createFlashContainer() {
    const container = document.createElement('div');
    container.className = 'flash-messages';
    document.querySelector('.main-content').insertBefore(container, document.querySelector('.main-content').firstChild);
    return container;
}

// Phone mask
const telefoneInput = document.getElementById('telefone-presenteador');
if (telefoneInput) {
    telefoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            if (value.length < 15) {
                value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            }
        }
        e.target.value = value;
    });
}

// Close modal on ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeGiftModal();
    }
});
</script>
{% endblock %}
